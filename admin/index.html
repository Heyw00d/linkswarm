<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkSwarm Admin üêù</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0a0f; color: #fff; }
        .glow { box-shadow: 0 0 30px rgba(251, 191, 36, 0.2); }
        .card { background: #12121a; border: 1px solid #252533; border-radius: 12px; padding: 20px; }
        .honey { color: #fbbf24; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen p-6">
    <!-- Auth Gate -->
    <div id="authGate" class="fixed inset-0 bg-[#0a0a0f] z-50 flex items-center justify-center">
        <div class="card glow max-w-sm w-full text-center">
            <div class="text-4xl mb-4">üêù</div>
            <h2 class="text-xl font-bold honey mb-2">Admin Access</h2>
            <form id="authForm" class="space-y-4">
                <input type="password" id="pwd" placeholder="Password" 
                    class="w-full px-4 py-3 bg-[#1a1a25] border border-[#252533] rounded-lg focus:border-[#fbbf24] outline-none">
                <button type="submit" class="w-full py-3 bg-[#fbbf24] text-black font-bold rounded-lg hover:bg-[#f59e0b]">
                    Enter
                </button>
                <p id="authError" class="text-red-400 text-sm hidden">Wrong password</p>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden max-w-6xl mx-auto">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <span class="text-3xl">üêù</span>
                <h1 class="text-2xl font-bold">LinkSwarm <span class="honey">Admin</span></h1>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-400">
                <span class="w-2 h-2 bg-green-400 rounded-full pulse"></span>
                <span id="lastUpdate">Loading...</span>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-6 gap-4 mb-8">
            <div class="card">
                <div class="text-sm text-gray-400 mb-1">Waitlist</div>
                <div class="text-3xl font-bold honey" id="statWaitlist">-</div>
            </div>
            <div class="card">
                <div class="text-sm text-gray-400 mb-1">API Keys</div>
                <div class="text-3xl font-bold text-purple-400" id="statApiKeys">-</div>
            </div>
            <div class="card">
                <div class="text-sm text-gray-400 mb-1">Sites</div>
                <div class="text-3xl font-bold" id="statSites">-</div>
            </div>
            <div class="card">
                <div class="text-sm text-gray-400 mb-1">Exchanges</div>
                <div class="text-3xl font-bold" id="statExchanges">-</div>
            </div>
            <div class="card">
                <div class="text-sm text-gray-400 mb-1">Sales</div>
                <div class="text-3xl font-bold text-green-400" id="statSales">-</div>
            </div>
            <div class="card">
                <div class="text-sm text-gray-400 mb-1">Revenue</div>
                <div class="text-3xl font-bold text-green-400" id="statRevenue">-</div>
            </div>
        </div>

        <!-- API Usage Stats -->
        <div class="grid grid-cols-5 gap-4 mb-8">
            <div class="card border-l-4 border-blue-500">
                <div class="text-sm text-gray-400 mb-1">API Requests (24h)</div>
                <div class="text-2xl font-bold text-blue-400" id="statRequests24h">-</div>
            </div>
            <div class="card border-l-4 border-blue-500">
                <div class="text-sm text-gray-400 mb-1">Requests (7d)</div>
                <div class="text-2xl font-bold text-blue-400" id="statRequests7d">-</div>
            </div>
            <div class="card border-l-4 border-cyan-500">
                <div class="text-sm text-gray-400 mb-1">Total Requests</div>
                <div class="text-2xl font-bold text-cyan-400" id="statRequestsTotal">-</div>
            </div>
            <div class="card border-l-4 border-emerald-500">
                <div class="text-sm text-gray-400 mb-1">Unique Domains</div>
                <div class="text-2xl font-bold text-emerald-400" id="statUniqueDomains">-</div>
            </div>
            <div class="card border-l-4 border-violet-500">
                <div class="text-sm text-gray-400 mb-1">Unique IPs</div>
                <div class="text-2xl font-bold text-violet-400" id="statUniqueIps">-</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <!-- Recent Signups -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üìß Recent Signups</h2>
                <div id="signups" class="space-y-3">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Registry -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üåê Registry</h2>
                <div id="registry" class="space-y-3">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Sales Section -->
        <div class="grid grid-cols-2 gap-6 mt-6">
            <!-- Add Sale Form -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üí∞ Log Sale</h2>
                <form id="saleForm" class="space-y-3">
                    <input type="email" name="email" placeholder="Customer email" required
                        class="w-full px-3 py-2 bg-[#1a1a25] border border-[#252533] rounded-lg outline-none focus:border-[#fbbf24]">
                    <select name="plan" required
                        class="w-full px-3 py-2 bg-[#1a1a25] border border-[#252533] rounded-lg outline-none focus:border-[#fbbf24]">
                        <option value="">Select plan...</option>
                        <option value="pro">Pro ($29/mo)</option>
                        <option value="agency">Agency ($99/mo)</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="number" name="amount" placeholder="Amount ($)" step="0.01" required
                        class="w-full px-3 py-2 bg-[#1a1a25] border border-[#252533] rounded-lg outline-none focus:border-[#fbbf24]">
                    <input type="text" name="notes" placeholder="Notes (optional)"
                        class="w-full px-3 py-2 bg-[#1a1a25] border border-[#252533] rounded-lg outline-none focus:border-[#fbbf24]">
                    <button type="submit" class="w-full py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg">
                        Log Sale
                    </button>
                </form>
            </div>

            <!-- Recent Sales -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üìà Recent Sales</h2>
                <div id="recentSales" class="space-y-3">
                    <div class="text-gray-500">No sales yet</div>
                </div>
            </div>
        </div>

        <!-- API Keys -->
        <div class="card mt-6">
            <h2 class="text-lg font-semibold mb-4">üîë API Keys</h2>
            <div id="apiKeys" class="space-y-2 max-h-80 overflow-y-auto">
                <div class="text-gray-500">Loading...</div>
            </div>
        </div>

        <!-- All Waitlist -->
        <div class="card mt-6">
            <h2 class="text-lg font-semibold mb-4">üìã Full Waitlist</h2>
            <div id="fullWaitlist" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="text-gray-500">Loading...</div>
            </div>
        </div>

        <!-- Pool Matches Section -->
        <div class="card mt-6">
            <h2 class="text-lg font-semibold mb-4">üîó Link Pool Activity</h2>
            <div class="grid grid-cols-5 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400" id="statVerifiedPlacements">-</div>
                    <div class="text-xs text-gray-500">Verified Links</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-400" id="statPendingPlacements">-</div>
                    <div class="text-xs text-gray-500">Pending</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400" id="statTotalPlacements">-</div>
                    <div class="text-xs text-gray-500">Total Matches</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400" id="statAvailableSlots">-</div>
                    <div class="text-xs text-gray-500">Available Slots</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-400" id="statPendingRequests">-</div>
                    <div class="text-xs text-gray-500">Pending Requests</div>
                </div>
            </div>
            <h3 class="text-sm font-semibold text-gray-400 mb-2 mt-4">Recent Placements</h3>
            <div id="recentPlacements" class="space-y-2 max-h-64 overflow-y-auto text-sm">
                <div class="text-gray-500">Loading...</div>
            </div>
        </div>

        <!-- Contributions & Requests -->
        <div class="grid grid-cols-2 gap-6 mt-6">
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üì• Recent Contributions</h2>
                <div id="recentContributions" class="space-y-2 max-h-48 overflow-y-auto text-sm">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üì§ Recent Link Requests</h2>
                <div id="recentLinkRequests" class="space-y-2 max-h-48 overflow-y-auto text-sm">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- API Usage Section -->
        <div class="grid grid-cols-3 gap-6 mt-6">
            <!-- Top Endpoints -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üéØ Top Endpoints (24h)</h2>
                <div id="topEndpoints" class="space-y-2">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Top Domains -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üåê Top Domains (7d)</h2>
                <div id="topDomains" class="space-y-2">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Recent Requests -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üì° Recent API Requests</h2>
                <div id="recentRequests" class="space-y-2 max-h-80 overflow-y-auto text-xs">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://api.linkswarm.ai';
        let token = '';

        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            token = document.getElementById('pwd').value;
            
            try {
                const res = await fetch(`${API}/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    sessionStorage.setItem('linkswarm_token', token);
                    document.getElementById('authGate').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadData();
                } else {
                    document.getElementById('authError').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('authError').textContent = 'Connection error';
                document.getElementById('authError').classList.remove('hidden');
            }
        };

        async function loadData() {
            try {
                // Stats
                const statsRes = await fetch(`${API}/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await statsRes.json();
                
                document.getElementById('statWaitlist').textContent = stats.waitlist;
                document.getElementById('statApiKeys').textContent = stats.apiKeys || 0;
                document.getElementById('statSites').textContent = stats.sites;
                document.getElementById('statExchanges').textContent = stats.exchanges;
                document.getElementById('statSales').textContent = stats.sales || 0;
                document.getElementById('statRevenue').textContent = '$' + ((stats.revenue || 0) / 100).toFixed(0);
                
                // API request stats
                if (stats.apiRequests) {
                    document.getElementById('statRequests24h').textContent = stats.apiRequests.last24h.toLocaleString();
                    document.getElementById('statRequests7d').textContent = stats.apiRequests.last7d.toLocaleString();
                    document.getElementById('statRequestsTotal').textContent = stats.apiRequests.total.toLocaleString();
                    document.getElementById('statUniqueDomains').textContent = stats.apiRequests.uniqueDomains;
                    document.getElementById('statUniqueIps').textContent = stats.apiRequests.uniqueIps;
                }
                
                // Top endpoints
                if (stats.topEndpoints && stats.topEndpoints.length > 0) {
                    document.getElementById('topEndpoints').innerHTML = stats.topEndpoints.map(e => `
                        <div class="flex justify-between items-center py-1 border-b border-[#252533]">
                            <span class="font-mono text-xs truncate">${e.path}</span>
                            <span class="text-blue-400 font-bold ml-2">${e.hits}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('topEndpoints').innerHTML = '<div class="text-gray-500">No data yet</div>';
                }
                
                // Top domains
                if (stats.topDomains && stats.topDomains.length > 0) {
                    document.getElementById('topDomains').innerHTML = stats.topDomains.map(d => `
                        <div class="flex justify-between items-center py-1 border-b border-[#252533]">
                            <span class="font-mono text-xs truncate">${d.domain}</span>
                            <span class="text-emerald-400 font-bold ml-2">${d.hits}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('topDomains').innerHTML = '<div class="text-gray-500">No domains tracked yet</div>';
                }
                
                // Recent requests
                if (stats.recentRequests && stats.recentRequests.length > 0) {
                    document.getElementById('recentRequests').innerHTML = stats.recentRequests.slice(0, 20).map(r => {
                        const statusColor = r.status_code < 300 ? 'text-green-400' : r.status_code < 400 ? 'text-yellow-400' : 'text-red-400';
                        const time = new Date(r.created_at).toLocaleTimeString();
                        return `
                            <div class="py-1 border-b border-[#252533]">
                                <div class="flex justify-between">
                                    <span><span class="text-cyan-400">${r.method}</span> <span class="text-gray-300">${r.path}</span></span>
                                    <span class="${statusColor}">${r.status_code || '-'}</span>
                                </div>
                                <div class="flex justify-between text-gray-500">
                                    <span>${r.domain || r.ip || '-'}</span>
                                    <span>${r.duration_ms ? r.duration_ms + 'ms' : ''} ${time}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('recentRequests').innerHTML = '<div class="text-gray-500">No requests logged yet</div>';
                }
                
                // API Keys
                if (stats.recentKeys && stats.recentKeys.length > 0) {
                    document.getElementById('apiKeys').innerHTML = stats.recentKeys.map(k => `
                        <div class="flex justify-between items-center py-2 border-b border-[#252533]">
                            <div class="flex-1 min-w-0">
                                <span class="font-mono text-sm text-purple-300">${k.email}</span>
                                <div class="text-xs text-gray-500 font-mono truncate">${k.api_key}</div>
                            </div>
                            <div class="text-right ml-4">
                                <span class="text-xs px-2 py-1 rounded ${k.plan === 'free' ? 'bg-gray-700' : 'bg-green-700'}">${k.plan}</span>
                                <div class="text-xs text-gray-500 mt-1">${k.requests_total || 0} reqs</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('apiKeys').innerHTML = '<div class="text-gray-500">No API keys yet</div>';
                }
                
                // Recent sales
                if (stats.recentSales && stats.recentSales.length > 0) {
                    document.getElementById('recentSales').innerHTML = stats.recentSales.map(s => `
                        <div class="flex justify-between items-center py-2 border-b border-[#252533]">
                            <div>
                                <span class="font-mono text-sm">${s.email}</span>
                                <span class="text-xs text-gray-500 ml-2">${s.plan}</span>
                            </div>
                            <span class="text-green-400 font-bold">$${(s.amount_cents / 100).toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('recentSales').innerHTML = '<div class="text-gray-500">No sales yet</div>';
                }
                
                // Recent signups
                if (stats.recentSignups && stats.recentSignups.length > 0) {
                    document.getElementById('signups').innerHTML = stats.recentSignups.map(s => `
                        <div class="flex justify-between items-center py-2 border-b border-[#252533]">
                            <span class="font-mono text-sm">${s.email}</span>
                            <span class="text-xs text-gray-500">${new Date(s.created_at).toLocaleDateString()}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('signups').innerHTML = '<div class="text-gray-500">No signups yet</div>';
                }

                // Registry
                const regRes = await fetch(`${API}/registry`);
                const reg = await regRes.json();
                
                document.getElementById('registry').innerHTML = reg.sites.map(s => `
                    <div class="flex justify-between items-center py-2 border-b border-[#252533]">
                        <div>
                            <span class="font-semibold">${s.name}</span>
                            <span class="text-xs text-gray-500 ml-2">${s.domain}</span>
                        </div>
                        <span class="text-xs ${s.verified ? 'text-green-400' : 'text-gray-500'}">${s.verified ? '‚úì Verified' : 'Pending'}</span>
                    </div>
                `).join('');

                // Full waitlist
                const wlRes = await fetch(`${API}/waitlist`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const wl = await wlRes.json();
                
                if (wl.signups && wl.signups.length > 0) {
                    document.getElementById('fullWaitlist').innerHTML = wl.signups.map(s => `
                        <div class="flex justify-between items-center py-1 text-sm">
                            <span class="font-mono">${s.email}</span>
                            <span class="text-xs text-gray-500">${s.source} ‚Ä¢ ${new Date(s.created_at).toLocaleString()}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('fullWaitlist').innerHTML = '<div class="text-gray-500">No signups yet</div>';
                }

                // Pool stats
                if (stats.pool) {
                    document.getElementById('statTotalPlacements').textContent = stats.pool.totalPlacements;
                    document.getElementById('statVerifiedPlacements').textContent = stats.pool.verifiedPlacements;
                    document.getElementById('statPendingPlacements').textContent = stats.pool.pendingPlacements;
                    document.getElementById('statAvailableSlots').textContent = stats.pool.availableSlots;
                    document.getElementById('statPendingRequests').textContent = stats.pool.pendingRequests;
                }
                
                // Recent placements
                if (stats.recentPlacements && stats.recentPlacements.length > 0) {
                    document.getElementById('recentPlacements').innerHTML = stats.recentPlacements.map(p => {
                        const statusColor = p.status === 'verified' ? 'text-green-400' : p.status === 'placed' ? 'text-yellow-400' : 'text-gray-400';
                        const linkType = p.link_type === 'dofollow' ? 'üîó' : 'üîí';
                        const date = new Date(p.assigned_at).toLocaleDateString();
                        return `
                            <div class="py-2 border-b border-[#252533]">
                                <div class="flex justify-between items-center">
                                    <span class="font-mono text-xs">
                                        <span class="text-blue-400">${p.from_domain}</span> 
                                        <span class="text-gray-500">‚Üí</span> 
                                        <span class="text-green-400">${p.to_domain}</span>
                                    </span>
                                    <span class="${statusColor} text-xs">${linkType} ${p.status}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${p.anchor_text ? `"${p.anchor_text}"` : ''} 
                                    ${p.relevance_score ? `‚Ä¢ Score: ${(p.relevance_score * 100).toFixed(0)}%` : ''} 
                                    ‚Ä¢ ${date}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('recentPlacements').innerHTML = '<div class="text-gray-500">No placements yet</div>';
                }
                
                // Recent contributions
                if (stats.recentContributions && stats.recentContributions.length > 0) {
                    document.getElementById('recentContributions').innerHTML = stats.recentContributions.map(c => {
                        const statusColor = c.status === 'available' ? 'text-green-400' : c.status === 'filled' ? 'text-yellow-400' : 'text-gray-400';
                        return `
                            <div class="py-2 border-b border-[#252533] flex justify-between">
                                <div>
                                    <span class="font-mono text-xs text-purple-300">${c.site_domain}</span>
                                    <span class="text-gray-500 text-xs ml-2">${c.page_url}</span>
                                </div>
                                <div class="text-right">
                                    <span class="${statusColor} text-xs">${c.links_placed}/${c.max_links}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('recentContributions').innerHTML = '<div class="text-gray-500">No contributions yet</div>';
                }
                
                // Recent link requests
                if (stats.recentLinkRequests && stats.recentLinkRequests.length > 0) {
                    document.getElementById('recentLinkRequests').innerHTML = stats.recentLinkRequests.map(r => {
                        const statusColor = r.status === 'matched' ? 'text-green-400' : r.status === 'pending' ? 'text-yellow-400' : 'text-gray-400';
                        return `
                            <div class="py-2 border-b border-[#252533] flex justify-between">
                                <div>
                                    <span class="font-mono text-xs text-orange-300">${r.site_domain}</span>
                                    <span class="text-gray-500 text-xs ml-2">${r.target_page}</span>
                                </div>
                                <div class="text-right">
                                    <span class="${statusColor} text-xs">${r.status}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('recentLinkRequests').innerHTML = '<div class="text-gray-500">No requests yet</div>';
                }

                document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
                
            } catch (e) {
                console.error('Load error:', e);
            }
        }

        // Check for stored token
        const stored = sessionStorage.getItem('linkswarm_token');
        if (stored) {
            token = stored;
            fetch(`${API}/stats`, { headers: { 'Authorization': `Bearer ${token}` } })
                .then(r => {
                    if (r.ok) {
                        document.getElementById('authGate').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        loadData();
                    }
                });
        }

        // Sale form submission
        document.getElementById('saleForm').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                email: form.email.value,
                plan: form.plan.value,
                amount: parseFloat(form.amount.value),
                notes: form.notes.value
            };
            
            try {
                const res = await fetch(`${API}/sales`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    form.reset();
                    loadData();
                } else {
                    alert('Failed to log sale');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        // Auto-refresh every 30s
        setInterval(() => {
            if (token) loadData();
        }, 30000);
    </script>
</body>
</html>
