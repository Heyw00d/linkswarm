<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî LinkSwarm</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0f0f23 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .glow { box-shadow: 0 0 30px rgba(251,191,36,0.1); }
        .plan-free { border-color: #6b7280; }
        .plan-pro { border-color: #8b5cf6; }
        .plan-agency { border-color: #f59e0b; }
    </style>
</head>
<body class="text-white">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-md w-full glow">
            <div class="text-center mb-8">
                <div class="text-4xl mb-2">üêù</div>
                <h1 class="text-2xl font-bold">LinkSwarm Dashboard</h1>
                <p class="text-gray-400 mt-2">Access your dashboard</p>
            </div>
            
            <!-- Login Tabs -->
            <div class="flex mb-6 border-b border-gray-700">
                <button onclick="showLoginTab('email')" id="tabEmail" class="flex-1 py-2 text-center text-amber-400 border-b-2 border-amber-400 font-medium">Email</button>
                <button onclick="showLoginTab('apikey')" id="tabApiKey" class="flex-1 py-2 text-center text-gray-400 hover:text-white">API Key</button>
            </div>
            
            <!-- Email Login -->
            <div id="emailLogin" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Email Address</label>
                    <input type="email" id="emailInput" placeholder="you@example.com" 
                        class="w-full bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-amber-500 focus:outline-none">
                </div>
                <button onclick="loginWithEmail()" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-semibold py-3 rounded-lg transition">
                    Send Login Link
                </button>
                <p id="emailSuccess" class="text-green-400 text-sm text-center hidden"></p>
                <p id="emailError" class="text-red-400 text-sm text-center hidden"></p>
            </div>
            
            <!-- API Key Login -->
            <div id="apiKeyLogin" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">API Key</label>
                    <input type="text" id="apiKeyInput" placeholder="sk_linkswarm_..." 
                        class="w-full bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-amber-500 focus:outline-none font-mono text-sm">
                </div>
                <button onclick="login()" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-semibold py-3 rounded-lg transition">
                    Access Dashboard
                </button>
                <p id="loginError" class="text-red-400 text-sm text-center hidden"></p>
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-700 text-center">
                <p class="text-gray-500 text-sm">Don't have an API key?</p>
                <a href="/" class="text-amber-400 hover:text-amber-300 text-sm">Sign up for free ‚Üí</a>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="hidden">
        <!-- Header -->
        <header class="glass border-b border-gray-800">
            <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                <a href="/" class="flex items-center gap-2">
                    <span class="text-2xl">üêù</span>
                    <span class="font-bold text-xl">LinkSwarm</span>
                </a>
                <div class="flex items-center gap-4">
                    <span id="userEmail" class="text-gray-400 text-sm"></span>
                    <button onclick="logout()" class="text-gray-400 hover:text-white text-sm">Logout</button>
                </div>
            </div>
        </header>
        
        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- Plan Banner -->
            <div id="planBanner" class="glass rounded-xl p-4 mb-8 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span id="planBadge" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                    <span id="planDesc" class="text-gray-400"></span>
                </div>
                <div id="upgradeSection" class="hidden">
                    <a id="upgradeLink" href="#" class="bg-amber-500 hover:bg-amber-600 text-black px-4 py-2 rounded-lg text-sm font-semibold transition">
                        Upgrade to Pro
                    </a>
                </div>
            </div>
            
            <!-- Network Seeding Notice -->
            <div id="seedingNotice" class="glass rounded-xl p-6 mb-8 border-l-4 border-amber-500">
                <div class="flex items-start gap-4">
                    <div class="text-3xl">üå±</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-amber-400 mb-2">Network is Growing!</h3>
                        <p class="text-gray-300 mb-4">
                            LinkSwarm is in early access. As the network grows, you'll get more link opportunities. 
                            Enable notifications to get alerted when new sites join your niche or when you get matched!
                        </p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="notifyMatches" class="w-4 h-4 accent-amber-500" checked>
                                <span class="text-sm">Email me when I get matched</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="notifyNewSites" class="w-4 h-4 accent-amber-500" checked>
                                <span class="text-sm">Email me when new sites join my niche</span>
                            </label>
                        </div>
                        <div class="mt-4">
                            <button onclick="toggleWebhook()" class="text-amber-400 hover:text-amber-300 text-sm flex items-center gap-1">
                                <span id="webhookToggleText">+ Add webhook for real-time alerts</span>
                            </button>
                            <div id="webhookSection" class="hidden mt-3">
                                <div class="flex gap-2">
                                    <input type="text" id="webhookUrl" placeholder="https://yoursite.com/webhook" 
                                        class="flex-1 bg-black/30 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-amber-500 focus:outline-none">
                                    <button onclick="saveWebhook()" class="bg-amber-500 hover:bg-amber-600 text-black px-4 py-2 rounded-lg text-sm font-semibold">
                                        Save
                                    </button>
                                </div>
                                <p class="text-gray-500 text-xs mt-2">We'll POST events: match_received, match_assigned, new_site</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass rounded-xl p-4">
                    <div class="text-gray-400 text-sm">Sites</div>
                    <div class="text-2xl font-bold"><span id="statSites">0</span> / <span id="statSitesLimit">1</span></div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-gray-400 text-sm">API Requests Today</div>
                    <div class="text-2xl font-bold"><span id="statRequests">0</span> / <span id="statRequestsLimit">100</span></div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-gray-400 text-sm">Exchanges This Month</div>
                    <div class="text-2xl font-bold"><span id="statExchanges">0</span> / <span id="statExchangesLimit">5</span></div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-gray-400 text-sm">Total Requests</div>
                    <div class="text-2xl font-bold" id="statTotalRequests">0</div>
                </div>
                <div class="glass rounded-xl p-4 border border-amber-500/30">
                    <div class="text-amber-400 text-sm">üí∞ Credits</div>
                    <div class="text-2xl font-bold text-amber-400" id="statCredits">0</div>
                </div>
            </div>
            
            <!-- Exchanges Section - TOP PRIORITY -->
            <div class="glass rounded-xl p-6 mb-8 border border-amber-500/20">
                <h2 class="text-lg font-semibold mb-4">üîó Recent Exchanges</h2>
                <div id="exchangesList" class="space-y-3">
                    <p class="text-gray-500">No exchanges yet. Register a site and start discovering link partners!</p>
                </div>
            </div>
            
            <!-- API Key Section -->
            <div class="glass rounded-xl p-6 mb-8">
                <h2 class="text-lg font-semibold mb-4">üîë Your API Key</h2>
                <div class="flex items-center gap-4">
                    <code id="apiKeyDisplay" class="flex-1 bg-black/30 px-4 py-3 rounded-lg font-mono text-sm text-amber-400 select-all"></code>
                    <button onclick="copyApiKey()" class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition">
                        Copy
                    </button>
                    <button onclick="rotateKey()" class="bg-red-600/80 hover:bg-red-600 px-4 py-3 rounded-lg transition text-sm">
                        üîÑ Rotate
                    </button>
                </div>
                <p class="text-gray-500 text-sm mt-2">Use this key in your API requests: <code class="text-gray-400">Authorization: Bearer YOUR_KEY</code></p>
            </div>
            
            <!-- Sites Section -->
            <div class="glass rounded-xl p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">üåê Your Sites</h2>
                    <button onclick="showAddSite()" class="bg-amber-500 hover:bg-amber-600 text-black px-4 py-2 rounded-lg text-sm font-semibold transition">
                        + Add Site
                    </button>
                </div>
                <div id="sitesList" class="space-y-3">
                    <p class="text-gray-500">No sites registered yet. Add your first site to start exchanging links!</p>
                </div>
            </div>
            
            <!-- Add Site Modal -->
            <div id="addSiteModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="glass rounded-xl p-6 max-w-md w-full">
                    <h3 class="text-lg font-semibold mb-4">Add New Site</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Domain</label>
                            <input type="text" id="newSiteDomain" placeholder="example.com" 
                                class="w-full bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-amber-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Name</label>
                            <input type="text" id="newSiteName" placeholder="My Awesome Site" 
                                class="w-full bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-amber-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Description</label>
                            <textarea id="newSiteDesc" placeholder="A brief description of your site..." rows="2"
                                class="w-full bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-amber-500 focus:outline-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Categories (comma-separated)</label>
                            <input type="text" id="newSiteCategories" placeholder="tech, ai, crypto" 
                                class="w-full bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-amber-500 focus:outline-none">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="hideAddSite()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition">Cancel</button>
                        <button onclick="addSite()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-black font-semibold py-3 rounded-lg transition">Add Site</button>
                    </div>
                    <p id="addSiteError" class="text-red-400 text-sm text-center mt-3 hidden"></p>
                </div>
            </div>
            
            <!-- Analyze Partner Modal -->
            <div id="analyzeModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="glass rounded-xl p-6 max-w-lg w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">üìä Site Analysis</h3>
                        <button onclick="hideAnalyzeModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
                    </div>
                    <div id="analyzeContent">
                        <p class="text-gray-400">Loading...</p>
                    </div>
                </div>
            </div>
            
            <!-- Post-Accept Modal - Shows after accepting an exchange -->
            <div id="postAcceptModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="glass rounded-xl p-6 max-w-xl w-full max-h-[85vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">‚úÖ Exchange Accepted!</h3>
                        <button onclick="hidePostAcceptModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
                    </div>
                    
                    <!-- How it works -->
                    <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">üîÑ</span>
                            <div>
                                <p class="font-semibold text-amber-400 mb-1">How LinkSwarm works</p>
                                <p class="text-sm text-gray-300">This is <strong>not</strong> a reciprocal link exchange. You add a link to <span id="modalPartnerDomain" class="text-amber-400 font-semibold"></span>, and you'll receive a link from a <em>different</em> site in the network. This keeps link profiles natural.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Partner site info -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">üåê About the partner site</h4>
                        <div id="modalPartnerInfo" class="bg-black/20 rounded-lg p-4 text-sm">
                            <p class="text-gray-400">Loading partner info...</p>
                        </div>
                    </div>
                    
                    <!-- Suggested anchors -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">‚öì Suggested anchor text</h4>
                        <div id="modalAnchors" class="flex flex-wrap gap-2">
                            <span class="bg-gray-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-amber-600" onclick="copyAnchor(this)">Loading...</span>
                        </div>
                        <p class="text-gray-500 text-xs mt-2">Click to copy. Use natural, varied anchors.</p>
                    </div>
                    
                    <!-- AI Article option -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">ü§ñ Need content?</h4>
                        <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                            <p class="text-sm text-gray-300 mb-3">Generate an AI article that naturally includes the backlink. Perfect for blog posts.</p>
                            <button onclick="generateAIArticle()" id="generateArticleBtn" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2">
                                <span>‚ú® Generate Article (Free)</span>
                            </button>
                            <p class="text-gray-500 text-xs mt-2">Powered by AI. ~800 words with natural link placement.</p>
                            
                            <!-- Generated article result -->
                            <div id="generatedArticleBox" class="hidden mt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 id="generatedTitle" class="font-semibold text-purple-300"></h5>
                                    <button onclick="copyGeneratedArticle()" class="bg-purple-600 hover:bg-purple-500 px-3 py-1 rounded text-xs font-semibold transition">
                                        üìã Copy
                                    </button>
                                </div>
                                <textarea id="generatedArticle" readonly class="w-full h-64 bg-black/50 border border-purple-500/30 rounded-lg p-3 text-sm text-gray-200 font-mono resize-y"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Completion form -->
                    <div class="border-t border-gray-700 pt-4">
                        <h4 class="font-semibold mb-2">üì§ Mark as complete</h4>
                        <p class="text-sm text-gray-400 mb-3">Once you've added the link, submit the URL for verification.</p>
                        <div class="flex gap-2">
                            <input type="text" id="completionUrl" placeholder="https://yoursite.com/page-with-link" 
                                class="flex-1 bg-black/30 border border-gray-700 rounded-lg px-4 py-3 focus:border-green-500 focus:outline-none text-sm">
                            <button onclick="markExchangeComplete()" class="bg-green-600 hover:bg-green-500 px-4 py-3 rounded-lg font-semibold transition whitespace-nowrap">
                                ‚úì Complete
                            </button>
                        </div>
                        <p class="text-gray-500 text-xs mt-2">We'll verify the link exists. You'll earn credits once confirmed.</p>
                    </div>
                </div>
            </div>
            
            <!-- Discover Partners Section -->
            <div id="discoverSection" class="glass rounded-xl p-6 mb-8 hidden">
                <h2 class="text-lg font-semibold mb-4">üîç Discover Partners</h2>
                <div class="flex flex-wrap gap-3 mb-4">
                    <select id="discoverFromSite" class="bg-black/30 border border-gray-700 rounded-lg px-4 py-2 focus:border-amber-500 focus:outline-none">
                        <option value="">Select your site...</option>
                    </select>
                    <input type="text" id="discoverCategories" placeholder="Filter by category..." 
                        class="flex-1 min-w-48 bg-black/30 border border-gray-700 rounded-lg px-4 py-2 focus:border-amber-500 focus:outline-none">
                    <button onclick="discoverPartners()" class="bg-amber-500 hover:bg-amber-600 text-black px-4 py-2 rounded-lg font-semibold transition">
                        Search
                    </button>
                </div>
                <div id="discoverResults" class="space-y-3">
                    <p class="text-gray-500">Select a site and search to find matching link partners.</p>
                </div>
            </div>
            
            <!-- Quick Start -->
            <div class="glass rounded-xl p-6">
                <h2 class="text-lg font-semibold mb-4">üöÄ Quick Start</h2>
                <div class="space-y-4 text-sm">
                    <div class="flex items-start gap-3">
                        <span class="bg-amber-500 text-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 font-bold">1</span>
                        <div>
                            <p class="font-semibold">Register your site</p>
                            <p class="text-gray-400">Add your domain to the network</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="bg-amber-500 text-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 font-bold">2</span>
                        <div>
                            <p class="font-semibold">Verify ownership</p>
                            <p class="text-gray-400">Add a DNS TXT record or meta tag</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="bg-amber-500 text-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 font-bold">3</span>
                        <div>
                            <p class="font-semibold">Discover partners</p>
                            <p class="text-gray-400">Find relevant sites for link exchanges</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="bg-amber-500 text-black w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 font-bold">4</span>
                        <div>
                            <p class="font-semibold">Exchange links</p>
                            <p class="text-gray-400">Give a link, get a link from the network</p>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <a href="/docs/api/" class="text-amber-400 hover:text-amber-300 text-sm">Read the full API documentation ‚Üí</a>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const API = 'https://api.linkswarm.ai';
        let currentApiKey = localStorage.getItem('linkswarm_api_key') || '';
        
        // Check URL for magic link token
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');
        const emailFromUrl = urlParams.get('email');
        if (tokenFromUrl && emailFromUrl) {
            // Verify token and get API key
            fetch(`${API}/v1/auth/verify-token?token=${tokenFromUrl}&email=${encodeURIComponent(emailFromUrl)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.api_key) {
                        currentApiKey = data.api_key;
                        localStorage.setItem('linkswarm_api_key', data.api_key);
                        window.history.replaceState({}, '', '/dashboard/');
                        loadDashboard();
                    } else {
                        alert('Login link expired or invalid. Please request a new one.');
                    }
                })
                .catch(() => alert('Error verifying login link.'));
        } else if (tokenFromUrl) {
            // Legacy: direct API key in URL
            currentApiKey = tokenFromUrl;
            localStorage.setItem('linkswarm_api_key', tokenFromUrl);
            window.history.replaceState({}, '', '/dashboard/');
        }
        
        // Check if already logged in
        if (currentApiKey) {
            loadDashboard();
        }
        
        // Tab switching
        function showLoginTab(tab) {
            document.getElementById('emailLogin').classList.toggle('hidden', tab !== 'email');
            document.getElementById('apiKeyLogin').classList.toggle('hidden', tab !== 'apikey');
            document.getElementById('tabEmail').classList.toggle('text-amber-400', tab === 'email');
            document.getElementById('tabEmail').classList.toggle('border-amber-400', tab === 'email');
            document.getElementById('tabEmail').classList.toggle('border-b-2', tab === 'email');
            document.getElementById('tabEmail').classList.toggle('text-gray-400', tab !== 'email');
            document.getElementById('tabApiKey').classList.toggle('text-amber-400', tab === 'apikey');
            document.getElementById('tabApiKey').classList.toggle('border-amber-400', tab === 'apikey');
            document.getElementById('tabApiKey').classList.toggle('border-b-2', tab === 'apikey');
            document.getElementById('tabApiKey').classList.toggle('text-gray-400', tab !== 'apikey');
        }
        
        // Email login - sends magic link
        async function loginWithEmail() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) {
                showError('emailError', 'Please enter a valid email address');
                return;
            }
            
            try {
                const res = await fetch(`${API}/v1/auth/magic-link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('emailError').classList.add('hidden');
                    document.getElementById('emailSuccess').textContent = 'Check your email for a login link!';
                    document.getElementById('emailSuccess').classList.remove('hidden');
                } else {
                    showError('emailError', data.error || 'Email not found. Have you signed up?');
                }
            } catch (e) {
                showError('emailError', 'Connection error. Please try again.');
            }
        }
        
        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        
        async function login() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key || !key.startsWith('sk_linkswarm_')) {
                showError('loginError', 'Please enter a valid API key (starts with sk_linkswarm_)');
                return;
            }
            
            try {
                const res = await fetch(`${API}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                
                if (!res.ok) {
                    showError('loginError', 'Invalid API key');
                    return;
                }
                
                currentApiKey = key;
                localStorage.setItem('linkswarm_api_key', key);
                loadDashboard();
            } catch (e) {
                showError('loginError', 'Connection error. Please try again.');
            }
        }
        
        function logout() {
            localStorage.removeItem('linkswarm_api_key');
            currentApiKey = '';
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
        }
        
        async function loadDashboard() {
            try {
                const res = await fetch(`${API}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                
                if (!res.ok) {
                    logout();
                    return;
                }
                
                const data = await res.json();
                
                // Show dashboard
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardScreen').classList.remove('hidden');
                
                // Load notification settings
                loadNotificationSettings();
                
                // User info
                document.getElementById('userEmail').textContent = data.user.email;
                document.getElementById('apiKeyDisplay').textContent = data.user.api_key;
                
                // Plan
                const plan = data.user.plan || 'free';
                const badge = document.getElementById('planBadge');
                badge.textContent = plan.toUpperCase();
                badge.className = `px-3 py-1 rounded-full text-sm font-semibold ${
                    plan === 'agency' ? 'bg-amber-500 text-black' :
                    plan === 'pro' ? 'bg-purple-500 text-white' :
                    'bg-gray-600 text-white'
                }`;
                
                document.getElementById('planDesc').textContent = 
                    plan === 'agency' ? 'Unlimited power for agencies' :
                    plan === 'pro' ? 'Pro features unlocked' :
                    'Free tier ‚Äî upgrade for more';
                
                // Upgrade link
                if (data.upgrade_urls && plan === 'free') {
                    document.getElementById('upgradeSection').classList.remove('hidden');
                    document.getElementById('upgradeLink').href = data.upgrade_urls.pro;
                } else {
                    document.getElementById('upgradeSection').classList.add('hidden');
                }
                
                // Stats
                document.getElementById('statSites').textContent = data.limits.sites_used;
                document.getElementById('statSitesLimit').textContent = data.limits.sites;
                document.getElementById('statRequests').textContent = data.user.requests_today;
                document.getElementById('statRequestsLimit').textContent = data.limits.requests_per_day;
                document.getElementById('statExchanges').textContent = data.limits.exchanges_used_this_month;
                document.getElementById('statExchangesLimit').textContent = data.limits.exchanges_per_month;
                document.getElementById('statTotalRequests').textContent = data.user.requests_total.toLocaleString();
                
                // Credits
                const credits = data.credits?.balance || 0;
                document.getElementById('statCredits').textContent = credits;
                
                // Sites
                const sitesList = document.getElementById('sitesList');
                if (data.sites.length === 0) {
                    sitesList.innerHTML = '<p class="text-gray-500">No sites registered yet. Add your first site to start exchanging links!</p>';
                } else {
                    sitesList.innerHTML = data.sites.map(site => `
                        <div class="bg-black/20 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold">${site.domain}</span>
                                        ${site.verified ? 
                                            '<span class="bg-green-500/20 text-green-400 text-xs px-2 py-0.5 rounded">Verified</span>' :
                                            '<span class="bg-yellow-500/20 text-yellow-400 text-xs px-2 py-0.5 rounded">Pending</span>'
                                        }
                                        ${site.analyzed ?
                                            '<span class="bg-blue-500/20 text-blue-400 text-xs px-2 py-0.5 rounded">Analyzed</span>' :
                                            ''
                                        }
                                    </div>
                                    <div class="text-gray-400 text-sm">${site.name || site.domain}</div>
                                    ${site.categories?.length ? 
                                        `<div class="text-gray-500 text-xs mt-1">${site.categories.join(', ')}</div>` : ''
                                    }
                                </div>
                                ${!site.analyzed && site.verified ? `
                                    <button onclick="analyzeSite('${site.domain}')" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-sm transition">
                                        Analyze
                                    </button>
                                ` : ''}
                            </div>
                            ${!site.verified && site.verification_token ? `
                            <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 mb-3">
                                <div class="text-amber-400 text-sm font-medium mb-2">üîê Verify ownership</div>
                                <div class="text-gray-300 text-xs mb-2">Add one of these to verify:</div>
                                <div class="bg-black/40 rounded p-2 mb-2">
                                    <div class="text-gray-400 text-xs mb-1">DNS TXT Record:</div>
                                    <code class="text-amber-300 text-xs break-all">linkswarm-verify=${site.verification_token}</code>
                                </div>
                                <div class="bg-black/40 rounded p-2 mb-3">
                                    <div class="text-gray-400 text-xs mb-1">Or HTML meta tag:</div>
                                    <code class="text-amber-300 text-xs break-all">&lt;meta name="linkswarm-verify" content="${site.verification_token}"&gt;</code>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="verifySite('${site.domain}')" id="verify-btn-${site.domain.replace(/\./g, '-')}" class="bg-amber-600 hover:bg-amber-500 px-3 py-1.5 rounded text-sm transition flex items-center gap-1">
                                        <span>Verify Now</span>
                                    </button>
                                    <span id="verify-result-${site.domain.replace(/\./g, '-')}" class="text-sm"></span>
                                </div>
                            </div>
                            ` : ''}
                            <div class="grid grid-cols-4 gap-2 text-center">
                                <div class="bg-black/30 rounded px-2 py-1.5">
                                    <div class="text-amber-400 font-bold">${site.quality_score || 0}</div>
                                    <div class="text-gray-500 text-xs">Quality</div>
                                </div>
                                <div class="bg-black/30 rounded px-2 py-1.5">
                                    <div class="text-green-400 font-bold">${site.etv > 0 ? '$' + site.etv.toLocaleString() : '-'}</div>
                                    <div class="text-gray-500 text-xs">Est. Traffic</div>
                                </div>
                                <div class="bg-black/30 rounded px-2 py-1.5">
                                    <div class="text-blue-400 font-bold">${site.keywords > 0 ? site.keywords.toLocaleString() : '-'}</div>
                                    <div class="text-gray-500 text-xs">Keywords</div>
                                </div>
                                <div class="bg-black/30 rounded px-2 py-1.5">
                                    <div class="text-purple-400 font-bold">${site.reputation || 50}</div>
                                    <div class="text-gray-500 text-xs">Reputation</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Exchanges
                const exchangesList = document.getElementById('exchangesList');
                if (data.exchanges.length === 0) {
                    exchangesList.innerHTML = '<p class="text-gray-500">No exchanges yet. Register a site and start discovering link partners!</p>';
                } else {
                    const userDomains = data.sites.map(s => s.domain);
                    exchangesList.innerHTML = data.exchanges.map(ex => {
                        const isIncoming = userDomains.includes(ex.to_domain) && !userDomains.includes(ex.from_domain);
                        const isOutgoing = userDomains.includes(ex.from_domain);
                        const directionLabel = isIncoming ? '‚Üê you add link' : '‚Üí they add link';
                        const showActions = isIncoming && ex.status === 'pending';
                        const showComplete = isIncoming && ex.status === 'accepted';
                        
                        return `
                        <div class="bg-black/20 rounded-lg p-4" data-exchange-id="${ex.id}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="${isOutgoing ? 'text-amber-400' : 'text-gray-400'}">${ex.from_domain}</span>
                                    <span class="text-gray-500">‚Üí</span>
                                    <span class="${isIncoming ? 'text-amber-400' : 'text-gray-400'}">${ex.to_domain}</span>
                                    <span class="text-gray-600 text-xs">(${directionLabel})</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${showActions ? `
                                        <button onclick="acceptExchange(${ex.id}, '${ex.from_domain}')" class="bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-xs transition">Accept</button>
                                        <button onclick="respondExchange(${ex.id}, 'rejected')" class="bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-xs transition">Reject</button>
                                    ` : showComplete ? `
                                        <button onclick="showCompleteModal(${ex.id}, '${ex.from_domain}')" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs transition">Add Link</button>
                                        <span class="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400">accepted</span>
                                    ` : `
                                        <span class="text-xs px-2 py-1 rounded ${
                                            ex.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                                            ex.status === 'verified' ? 'bg-emerald-500/20 text-emerald-400' :
                                            ex.status === 'rejected' ? 'bg-red-500/20 text-red-400' :
                                            'bg-yellow-500/20 text-yellow-400'
                                        }">${ex.status}</span>
                                        ${ex.status === 'verified' && ex.placement_url ? `
                                            <a href="${ex.placement_url}" target="_blank" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1 rounded text-xs transition">View Link</a>
                                        ` : ''}
                                    `}
                                </div>
                            </div>
                            ${ex.status === 'accepted' && isIncoming ? `
                                <div class="mt-2 text-xs text-blue-400">
                                    Add a link to <strong>${ex.from_domain}</strong> from your site. You'll receive a link from another site in the network.
                                </div>
                            ` : ex.status === 'accepted' && isOutgoing ? `
                                <div class="mt-2 text-xs text-green-400">
                                    ‚úì Partner accepted! They'll add your link soon. You'll be notified when verified.
                                </div>
                            ` : ex.status === 'completed' ? `
                                <div class="mt-2 text-xs text-green-400">
                                    ‚úì Link placed at: <a href="${ex.placement_url || '#'}" target="_blank" class="underline">${ex.placement_url || 'pending verification'}</a>
                                </div>
                            ` : ex.status === 'verified' && ex.placement_url ? `
                                <div class="mt-2 text-xs text-emerald-400">
                                    ‚úì Verified! <a href="${ex.placement_url}" target="_blank" class="underline hover:text-emerald-300">${ex.placement_url}</a>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('');
                }
                
                // Show discover section and populate dropdown if user has verified sites
                const verifiedSites = data.sites.filter(s => s.verified);
                const discoverSection = document.getElementById('discoverSection');
                const discoverDropdown = document.getElementById('discoverFromSite');
                
                if (verifiedSites.length > 0) {
                    discoverSection.classList.remove('hidden');
                    discoverDropdown.innerHTML = '<option value="">Select your site...</option>' + 
                        verifiedSites.map(s => `<option value="${s.domain}">${s.domain}</option>`).join('');
                } else {
                    discoverSection.classList.add('hidden');
                }
                
            } catch (e) {
                console.error(e);
                logout();
            }
        }
        
        function showAddSite() {
            document.getElementById('addSiteModal').classList.remove('hidden');
        }
        
        function hideAddSite() {
            document.getElementById('addSiteModal').classList.add('hidden');
            document.getElementById('addSiteError').classList.add('hidden');
        }
        
        async function addSite() {
            const domain = document.getElementById('newSiteDomain').value.trim();
            const name = document.getElementById('newSiteName').value.trim();
            const description = document.getElementById('newSiteDesc').value.trim();
            const categories = document.getElementById('newSiteCategories').value.split(',').map(c => c.trim()).filter(Boolean);
            
            if (!domain) {
                showError('addSiteError', 'Domain is required');
                return;
            }
            
            try {
                const res = await fetch(`${API}/v1/sites`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain, name, description, categories })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    showError('addSiteError', data.error || 'Failed to add site');
                    return;
                }
                
                // Site registered - show in dashboard with verification instructions
                hideAddSite();
                await loadDashboard();
                
                // Scroll to the sites section
                document.getElementById('sitesList').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                showError('addSiteError', 'Connection error');
            }
        }
        
        function copyApiKey() {
            navigator.clipboard.writeText(currentApiKey);
            alert('API key copied to clipboard!');
        }
        
        async function rotateKey() {
            if (!confirm('‚ö†Ô∏è This will invalidate your current API key immediately.\n\nAny integrations using the old key will stop working.\n\nContinue?')) {
                return;
            }
            
            try {
                const res = await fetch(`${API}/rotate-key`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                
                if (!res.ok) {
                    alert('Failed to rotate key. Please try again.');
                    return;
                }
                
                const data = await res.json();
                currentApiKey = data.apiKey;
                localStorage.setItem('linkswarm_api_key', data.apiKey);
                document.getElementById('apiKeyDisplay').textContent = data.apiKey;
                
                alert('‚úÖ API key rotated successfully!\n\nYour new key is now active. The old key has been invalidated.');
            } catch (e) {
                alert('Error rotating key: ' + e.message);
            }
        }
        
        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        
        async function analyzePartner(domain) {
            document.getElementById('analyzeModal').classList.remove('hidden');
            const content = document.getElementById('analyzeContent');
            content.innerHTML = '<p class="text-gray-400">üîç Analyzing ' + domain + '...</p>';
            
            try {
                // First get basic site info from registry
                const registryRes = await fetch(`${API}/registry?domain=${encodeURIComponent(domain)}`);
                const registryData = await registryRes.json();
                const site = registryData.sites?.find(s => s.domain === domain) || {};
                
                // Try to get detailed analysis if available
                let analysis = null;
                try {
                    const analysisRes = await fetch(`${API}/v1/sites/analyze`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentApiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ domain, external: true })
                    });
                    if (analysisRes.ok) {
                        analysis = await analysisRes.json();
                    }
                } catch (e) {}
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center pb-4 border-b border-gray-700">
                            <h4 class="text-xl font-bold text-amber-400">${domain}</h4>
                            ${site.name ? `<p class="text-gray-400">${site.name}</p>` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-black/30 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-amber-400">${site.quality_score || analysis?.quality_score || '?'}</div>
                                <div class="text-gray-500 text-xs">Quality Score</div>
                            </div>
                            <div class="bg-black/30 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-purple-400">${site.reputation || 50}</div>
                                <div class="text-gray-500 text-xs">Reputation</div>
                            </div>
                            <div class="bg-black/30 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-green-400">${site.etv ? '$' + site.etv.toLocaleString() : '-'}</div>
                                <div class="text-gray-500 text-xs">Est. Traffic Value</div>
                            </div>
                            <div class="bg-black/30 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-blue-400">${site.keywords?.toLocaleString() || '-'}</div>
                                <div class="text-gray-500 text-xs">Keywords</div>
                            </div>
                        </div>
                        
                        ${site.description ? `
                        <div class="bg-black/20 rounded-lg p-3">
                            <div class="text-gray-400 text-xs mb-1">Description</div>
                            <p class="text-gray-300 text-sm">${site.description}</p>
                        </div>
                        ` : ''}
                        
                        ${site.categories?.length ? `
                        <div class="bg-black/20 rounded-lg p-3">
                            <div class="text-gray-400 text-xs mb-1">Categories</div>
                            <div class="flex flex-wrap gap-1">
                                ${site.categories.map(c => `<span class="bg-amber-500/20 text-amber-400 text-xs px-2 py-0.5 rounded">${c}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex gap-2 pt-2">
                            <a href="https://${domain}" target="_blank" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-center transition text-sm">
                                Visit Site ‚Üó
                            </a>
                            <button onclick="hideAnalyzeModal()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-black py-2 rounded-lg transition text-sm font-semibold">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            } catch (e) {
                content.innerHTML = '<p class="text-red-400">Failed to analyze site. Please try again.</p>';
            }
        }
        
        function hideAnalyzeModal() {
            document.getElementById('analyzeModal').classList.add('hidden');
        }
        
        async function discoverPartners() {
            const domain = document.getElementById('discoverFromSite').value;
            const categories = document.getElementById('discoverCategories').value.trim();
            const resultsDiv = document.getElementById('discoverResults');
            
            if (!domain) {
                resultsDiv.innerHTML = '<p class="text-yellow-400">Please select one of your sites first.</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p class="text-gray-400">üîç Searching for partners...</p>';
            
            try {
                let url = `${API}/v1/discover?domain=${encodeURIComponent(domain)}&limit=10`;
                if (categories) {
                    url += `&categories=${encodeURIComponent(categories)}`;
                }
                
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    resultsDiv.innerHTML = `<p class="text-red-400">${data.error || 'Failed to discover partners'}</p>`;
                    return;
                }
                
                if (!data.matches || data.matches.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-gray-500">No matching partners found. Try different categories or check back later as more sites join.</p>';
                    return;
                }
                
                // Get existing exchanges to check for already proposed
                const exchangesRes = await fetch(`${API}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                const dashData = await exchangesRes.json();
                const existingExchanges = dashData.exchanges || [];
                
                resultsDiv.innerHTML = data.matches.map(match => {
                    const alreadyProposed = existingExchanges.some(ex => 
                        (ex.from_domain === domain && ex.to_domain === match.domain) ||
                        (ex.to_domain === domain && ex.from_domain === match.domain)
                    );
                    const existingEx = existingExchanges.find(ex => 
                        (ex.from_domain === domain && ex.to_domain === match.domain) ||
                        (ex.to_domain === domain && ex.from_domain === match.domain)
                    );
                    
                    return `
                    <div class="bg-black/20 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <span class="font-semibold">${match.domain}</span>
                                <span class="text-gray-400 text-sm ml-2">${match.name || ''}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="bg-amber-500/20 text-amber-400 text-xs px-2 py-0.5 rounded">${Math.round(match.relevance_score * 100)}% match</span>
                                <button onclick="analyzePartner('${match.domain}')" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm transition">
                                    Analyze
                                </button>
                                ${alreadyProposed ? `
                                    <span class="bg-gray-600 px-3 py-1 rounded text-sm">${existingEx?.status || 'proposed'}</span>
                                ` : `
                                    <button onclick="proposeExchange('${domain}', '${match.domain}')" class="bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-sm transition">
                                        Propose Link
                                    </button>
                                `}
                            </div>
                        </div>
                        ${match.description ? `<p class="text-gray-400 text-sm mb-2">${match.description}</p>` : ''}
                        ${match.categories?.length ? `<div class="text-gray-500 text-xs">${match.categories.join(', ')}</div>` : ''}
                        ${match.match_reason?.length ? `<div class="text-green-400/70 text-xs mt-1">‚úì ${match.match_reason.join(' ‚Ä¢ ')}</div>` : ''}
                    </div>
                `}).join('');
                
            } catch (e) {
                resultsDiv.innerHTML = '<p class="text-red-400">Connection error. Please try again.</p>';
            }
        }
        
        async function respondExchange(exchangeId, status) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = status === 'accepted' ? 'Accepting...' : 'Rejecting...';
            
            try {
                const res = await fetch(`${API}/v1/exchanges/${exchangeId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                if (res.ok) {
                    loadDashboard();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Failed to update exchange');
                    btn.disabled = false;
                    btn.textContent = status === 'accepted' ? 'Accept' : 'Reject';
                }
            } catch (e) {
                alert('Connection error');
                btn.disabled = false;
                btn.textContent = status === 'accepted' ? 'Accept' : 'Reject';
            }
        }
        
        async function proposeExchange(fromDomain, toDomain) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Proposing...';
            
            try {
                const res = await fetch(`${API}/v1/exchanges`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        from_domain: fromDomain, 
                        to_domain: toDomain 
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    btn.textContent = '‚úì Proposed';
                    btn.className = 'bg-green-800 px-3 py-1 rounded text-sm cursor-default';
                    // Reload to show in exchanges
                    setTimeout(() => loadDashboard(), 1000);
                } else {
                    btn.textContent = data.error || 'Failed';
                    btn.className = 'bg-red-600 px-3 py-1 rounded text-sm';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Propose Link';
                        btn.className = 'bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-sm transition';
                    }, 2000);
                }
            } catch (e) {
                btn.disabled = false;
                btn.textContent = 'Retry';
            }
        }
        
        async function verifySite(domain) {
            const btnId = `verify-btn-${domain.replace(/\./g, '-')}`;
            const resultId = `verify-result-${domain.replace(/\./g, '-')}`;
            const btn = document.getElementById(btnId);
            const result = document.getElementById(resultId);
            
            btn.disabled = true;
            btn.innerHTML = '<span>Checking...</span>';
            result.textContent = '';
            result.className = 'text-sm';
            
            try {
                const res = await fetch(`${API}/v1/sites/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain })
                });
                
                const data = await res.json();
                
                if (res.ok && data.verified) {
                    result.textContent = '‚úÖ Verified!';
                    result.className = 'text-sm text-green-400';
                    btn.innerHTML = '<span>Verified</span>';
                    btn.className = 'bg-green-600 px-3 py-1.5 rounded text-sm cursor-default';
                    // Reload dashboard after short delay to show updated status
                    setTimeout(() => loadDashboard(), 1500);
                } else {
                    result.textContent = '‚ùå ' + (data.error || 'Verification failed - check DNS/meta tag');
                    result.className = 'text-sm text-red-400';
                    btn.disabled = false;
                    btn.innerHTML = '<span>Retry</span>';
                }
            } catch (e) {
                result.textContent = '‚ùå Connection error';
                result.className = 'text-sm text-red-400';
                btn.disabled = false;
                btn.innerHTML = '<span>Retry</span>';
            }
        }
        
        async function analyzeSite(domain) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            
            try {
                const res = await fetch(`${API}/v1/sites/analyze`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    alert('Analysis failed: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'Analyze';
                    return;
                }
                
                alert(`‚úÖ Site analyzed!\n\nQuality Score: ${data.quality.score}/100\nEst. Traffic Value: $${data.quality.etv.toLocaleString()}\nKeywords: ${data.quality.keywords.toLocaleString()}\nTop 10 Rankings: ${data.quality.top10}`);
                loadDashboard();
            } catch (e) {
                alert('Error: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'Analyze';
            }
        }
        
        // Notification settings
        async function loadNotificationSettings() {
            try {
                const res = await fetch(`${API}/notifications`, {
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                if (res.ok) {
                    const settings = await res.json();
                    document.getElementById('notifyMatches').checked = settings.notify_matches;
                    document.getElementById('notifyNewSites').checked = settings.notify_new_sites;
                    if (settings.webhook_url) {
                        document.getElementById('webhookUrl').value = settings.webhook_url;
                        document.getElementById('webhookSection').classList.remove('hidden');
                        document.getElementById('webhookToggleText').textContent = '‚àí Edit webhook';
                    }
                }
            } catch (e) {
                console.error('Failed to load notification settings');
            }
        }
        
        async function saveNotificationSetting(field, value) {
            try {
                await fetch(`${API}/notifications`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ [field]: value })
                });
            } catch (e) {
                console.error('Failed to save setting');
            }
        }
        
        function toggleWebhook() {
            const section = document.getElementById('webhookSection');
            const text = document.getElementById('webhookToggleText');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                text.textContent = '‚àí Hide webhook settings';
            } else {
                section.classList.add('hidden');
                text.textContent = '+ Add webhook for real-time alerts';
            }
        }
        
        async function saveWebhook() {
            const url = document.getElementById('webhookUrl').value.trim();
            if (url && !url.startsWith('http')) {
                alert('Please enter a valid URL starting with http:// or https://');
                return;
            }
            await saveNotificationSetting('webhook_url', url || null);
            alert(url ? '‚úÖ Webhook saved!' : 'Webhook removed');
        }
        
        // Add event listeners for notification checkboxes
        document.getElementById('notifyMatches')?.addEventListener('change', (e) => {
            saveNotificationSetting('notify_matches', e.target.checked);
        });
        document.getElementById('notifyNewSites')?.addEventListener('change', (e) => {
            saveNotificationSetting('notify_new_sites', e.target.checked);
        });
        
        // Enter key to login
        document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        // ============ Post-Accept Modal Functions ============
        
        let currentExchangeId = null;
        let currentPartnerDomain = null;
        
        // Accept exchange and show the post-accept modal
        async function acceptExchange(exchangeId, partnerDomain) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Accepting...';
            
            try {
                const res = await fetch(`${API}/v1/exchanges/${exchangeId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'accepted' })
                });
                
                if (res.ok) {
                    // Show the post-accept modal with context
                    showPostAcceptModal(exchangeId, partnerDomain);
                    loadDashboard();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Failed to accept exchange');
                    btn.disabled = false;
                    btn.textContent = 'Accept';
                }
            } catch (e) {
                alert('Connection error');
                btn.disabled = false;
                btn.textContent = 'Accept';
            }
        }
        
        // Show the post-accept modal with partner info
        async function showPostAcceptModal(exchangeId, partnerDomain) {
            currentExchangeId = exchangeId;
            currentPartnerDomain = partnerDomain;
            
            document.getElementById('modalPartnerDomain').textContent = partnerDomain;
            document.getElementById('postAcceptModal').classList.remove('hidden');
            
            // Load partner site info
            const infoDiv = document.getElementById('modalPartnerInfo');
            infoDiv.innerHTML = '<p class="text-gray-400">Loading partner info...</p>';
            
            try {
                const res = await fetch(`${API}/v1/sites/${encodeURIComponent(partnerDomain)}/info`, {
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                
                if (res.ok) {
                    const info = await res.json();
                    infoDiv.innerHTML = `
                        <div class="mb-2">
                            <strong class="text-amber-400">${info.name || partnerDomain}</strong>
                            <a href="https://${partnerDomain}" target="_blank" class="text-gray-500 text-xs ml-2">‚Üó Visit</a>
                        </div>
                        ${info.description ? `<p class="text-gray-300 mb-2">${info.description}</p>` : ''}
                        ${info.categories?.length ? `<div class="text-gray-500 text-xs">Categories: ${info.categories.join(', ')}</div>` : ''}
                        ${info.quality ? `
                            <div class="mt-2 pt-2 border-t border-gray-700 grid grid-cols-3 gap-2 text-xs">
                                <div><span class="text-gray-500">Quality:</span> <span class="text-amber-400">${info.quality.score}/100</span></div>
                                <div><span class="text-gray-500">Traffic:</span> <span class="text-green-400">$${info.quality.etv?.toLocaleString() || '?'}</span></div>
                                <div><span class="text-gray-500">Keywords:</span> ${info.quality.keywords?.toLocaleString() || '?'}</div>
                            </div>
                        ` : ''}
                    `;
                } else {
                    infoDiv.innerHTML = `<p class="text-gray-300">${partnerDomain} <a href="https://${partnerDomain}" target="_blank" class="text-amber-400">‚Üó Visit site</a></p>`;
                }
            } catch (e) {
                infoDiv.innerHTML = `<p class="text-gray-300">${partnerDomain} <a href="https://${partnerDomain}" target="_blank" class="text-amber-400">‚Üó Visit site</a></p>`;
            }
            
            // Load suggested anchors
            const anchorsDiv = document.getElementById('modalAnchors');
            anchorsDiv.innerHTML = '<span class="text-gray-400 text-sm">Loading suggestions...</span>';
            
            try {
                const res = await fetch(`${API}/v1/sites/${encodeURIComponent(partnerDomain)}/anchors`, {
                    headers: { 'Authorization': `Bearer ${currentApiKey}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.anchors?.length) {
                        anchorsDiv.innerHTML = data.anchors.map(a => 
                            `<span class="bg-gray-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-amber-600 transition" onclick="copyAnchor(this)">${a}</span>`
                        ).join('');
                    } else {
                        // Default anchors
                        const defaultAnchors = [partnerDomain, `visit ${partnerDomain}`, 'learn more', 'check this out', 'recommended resource'];
                        anchorsDiv.innerHTML = defaultAnchors.map(a => 
                            `<span class="bg-gray-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-amber-600 transition" onclick="copyAnchor(this)">${a}</span>`
                        ).join('');
                    }
                } else {
                    const defaultAnchors = [partnerDomain, `visit ${partnerDomain}`, 'learn more'];
                    anchorsDiv.innerHTML = defaultAnchors.map(a => 
                        `<span class="bg-gray-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-amber-600 transition" onclick="copyAnchor(this)">${a}</span>`
                    ).join('');
                }
            } catch (e) {
                const defaultAnchors = [partnerDomain, 'learn more', 'check this out'];
                anchorsDiv.innerHTML = defaultAnchors.map(a => 
                    `<span class="bg-gray-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-amber-600 transition" onclick="copyAnchor(this)">${a}</span>`
                ).join('');
            }
        }
        
        // Show modal for already-accepted exchange (Add Link button)
        function showCompleteModal(exchangeId, partnerDomain) {
            showPostAcceptModal(exchangeId, partnerDomain);
        }
        
        function hidePostAcceptModal() {
            document.getElementById('postAcceptModal').classList.add('hidden');
            currentExchangeId = null;
            currentPartnerDomain = null;
            document.getElementById('completionUrl').value = '';
        }
        
        // Copy anchor text to clipboard
        function copyAnchor(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const original = element.textContent;
                element.textContent = '‚úì Copied!';
                element.classList.add('bg-green-600');
                setTimeout(() => {
                    element.textContent = original;
                    element.classList.remove('bg-green-600');
                }, 1500);
            });
        }
        
        // Copy generated article to clipboard
        function copyGeneratedArticle() {
            const textarea = document.getElementById('generatedArticle');
            navigator.clipboard.writeText(textarea.value).then(() => {
                const btn = event.target;
                const original = btn.innerHTML;
                btn.innerHTML = '‚úì Copied!';
                setTimeout(() => btn.innerHTML = original, 1500);
            });
        }
        
        // Mark exchange as complete
        async function markExchangeComplete() {
            const url = document.getElementById('completionUrl').value.trim();
            
            if (!url || !url.startsWith('http')) {
                alert('Please enter a valid URL where you placed the link');
                return;
            }
            
            if (!currentExchangeId) {
                alert('No exchange selected');
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            try {
                const res = await fetch(`${API}/v1/exchanges/${currentExchangeId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        placement_url: url,
                        partner_domain: currentPartnerDomain
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    const creditsMsg = data.credits_earned 
                        ? `\n\nüéâ +${data.credits_earned} credit earned!\nNew balance: ${data.new_balance} credits`
                        : '';
                    alert(`‚úÖ Link submitted successfully!${creditsMsg}`);
                    hidePostAcceptModal();
                    loadDashboard();
                } else {
                    alert(data.error || 'Failed to submit completion');
                    btn.disabled = false;
                    btn.textContent = '‚úì Complete';
                }
            } catch (e) {
                alert('Connection error');
                btn.disabled = false;
                btn.textContent = '‚úì Complete';
            }
        }
        
        // Generate AI article with backlink
        async function generateAIArticle() {
            if (!currentPartnerDomain) {
                alert('No partner site selected');
                return;
            }
            
            const btn = document.getElementById('generateArticleBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥ Generating...</span>';
            
            try {
                const res = await fetch(`${API}/v1/generate-content`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        target_domain: currentPartnerDomain,
                        exchange_id: currentExchangeId
                    })
                });
                
                if (res.status === 402) {
                    // Payment required - show payment info
                    const paymentInfo = await res.json();
                    // Free now - no payment required
                    btn.disabled = false;
                    btn.innerHTML = '<span>‚ú® Generate Article (Free)</span>';
                    return;
                }
                
                const data = await res.json();
                
                if (res.ok) {
                    // Show generated article in the textarea
                    const article = data.article || data.content;
                    const title = data.title || 'Generated Article';
                    
                    document.getElementById('generatedTitle').textContent = title;
                    document.getElementById('generatedArticle').value = article;
                    document.getElementById('generatedArticleBox').classList.remove('hidden');
                    
                    btn.innerHTML = '<span>‚úì Generated!</span>';
                    btn.disabled = false;
                } else {
                    alert(data.error || 'Failed to generate article');
                    btn.disabled = false;
                    btn.innerHTML = '<span>‚ú® Generate Article (Free)</span>';
                }
            } catch (e) {
                alert('Connection error');
                btn.disabled = false;
                btn.innerHTML = '<span>‚ú® Generate Article (Free)</span>';
            }
        }
    </script>
</body>
</html>
